<!DOCTYPE html>
<html>
<head>
  <base href="./">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JRR Immigration App">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="JRR Immigration">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>JRR Immigration</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- ULTIMATE FIX: Handle ALL Supabase auth scenarios including errors -->
  <script>
    // Comprehensive auth handler for ALL scenarios
    function handleAllAuthScenarios() {
      const currentUrl = window.location.href;
      const hash = window.location.hash;
      const search = window.location.search;
      
      console.log('üîó ULTIMATE URL Analysis:');
      console.log('   - Current URL:', currentUrl);
      console.log('   - Hash:', hash);
      console.log('   - Search:', search);
      
      // SCENARIO 0: Handle errors FIRST (expired tokens, etc.)
      if (currentUrl.includes('error=') || currentUrl.includes('error_code=')) {
        console.log('üéØ SCENARIO 0: Error parameters detected');
        handleAuthErrors();
        return;
      }
      
      // SCENARIO 1: Direct Supabase recovery link (user clicked email)
      if (currentUrl.includes('type=recovery') && (currentUrl.includes('access_token') || currentUrl.includes('token='))) {
        console.log('üéØ SCENARIO 1: Direct Supabase recovery link detected');
        handleDirectSupabaseRecovery();
        return;
      }
      
      // SCENARIO 2: Already stored tokens (from previous sessions)
      if (localStorage.getItem('password_reset_required') === 'true') {
        console.log('üéØ SCENARIO 2: Stored reset tokens detected');
        // Tokens already stored, let Flutter handle it - DON'T CLEAN URL HERE
        return;
      }
      
      // SCENARIO 3: URL parameters in main app
      if (hash.includes('access_token') || search.includes('access_token') || hash.includes('token=') || search.includes('token=')) {
        console.log('üéØ SCENARIO 3: URL parameters in main app');
        handleUrlParameters();
        return;
      }
      
      console.log('‚ÑπÔ∏è No special auth scenario detected');
      
      // Clean URL only if no special scenarios detected
      if (search || hash) {
        console.log('üßπ Cleaning URL - no auth scenarios detected');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // NEW: Handle authentication errors (expired tokens, etc.)
    function handleAuthErrors() {
      console.log('üîÑ Processing auth errors...');
      
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      const error = urlParams.get('error') || hashParams.get('error');
      const errorCode = urlParams.get('error_code') || hashParams.get('error_code');
      const errorDescription = urlParams.get('error_description') || hashParams.get('error_description');
      
      console.log('‚ùå Auth Error Details:', {
        error: error,
        errorCode: errorCode,
        errorDescription: errorDescription
      });

      // Store error information for Flutter to handle
      if (errorCode === 'otp_expired') {
        console.log('‚è∞ OTP expired error detected - storing for Flutter');
        localStorage.setItem('auth_error_type', 'otp_expired');
        localStorage.setItem('auth_error_timestamp', new Date().toISOString());
        
        // Store the original email if available in description
        if (errorDescription && errorDescription.includes('@')) {
          const emailMatch = errorDescription.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/);
          if (emailMatch) {
            localStorage.setItem('auth_error_email', emailMatch[1]);
          }
        }
      } else if (error) {
        localStorage.setItem('auth_error_type', error);
        localStorage.setItem('auth_error_timestamp', new Date().toISOString());
      }

      // Clean URL - remove all error parameters
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    function handleDirectSupabaseRecovery() {
      console.log('üîÑ Processing direct Supabase recovery link...');
      
      // Extract token from current URL (Supabase direct link)
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      const token = urlParams.get('access_token') || urlParams.get('token') || hashParams.get('access_token') || hashParams.get('token');
      const type = urlParams.get('type') || hashParams.get('type');
      
      console.log('üîê Direct Supabase extraction:', {
        token: token ? '***' + token.slice(-8) : null,
        type: type
      });
      
      if (token && type === 'recovery') {
        console.log('‚úÖ Valid recovery token from direct Supabase link');
        
        // Store tokens
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        localStorage.setItem('direct_supabase_link', 'true');
        
        console.log('üîê Tokens stored from direct Supabase link');
        
        // DON'T clean URL here - let Flutter see the original URL first
        console.log('‚ö†Ô∏è Keeping URL intact for Flutter detection');
      } else {
        console.log('‚ùå Invalid recovery token or type');
      }
    }

    function handleUrlParameters() {
      console.log('üîÑ Processing URL parameters...');
      
      const hash = window.location.hash;
      const search = window.location.search;
      
      const params = new URLSearchParams();
      
      // Add query parameters
      if (search) {
        const searchParams = new URLSearchParams(search.substring(1));
        for (const [key, value] of searchParams.entries()) {
          params.set(key, value);
        }
      }
      
      // Add hash parameters
      if (hash) {
        const hashPart = hash.includes('?') ? hash.split('?')[1] : hash.substring(1);
        const hashParams = new URLSearchParams(hashPart);
        for (const [key, value] of hashParams.entries()) {
          params.set(key, value);
        }
      }
      
      const token = params.get('access_token') || params.get('token');
      const type = params.get('type');
      
      if (token && type === 'recovery') {
        console.log('‚úÖ Valid recovery token from URL parameters');
        
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        
        // DON'T clean URL here - let Flutter see the original URL first
        console.log('‚ö†Ô∏è Keeping URL intact for Flutter detection');
      } else {
        console.log('‚ùå Invalid recovery token or type from URL parameters');
      }
    }

    function debugStoredTokens() {
      console.log('üîç DEBUG Stored Tokens:');
      console.log('   - reset_required:', localStorage.getItem('password_reset_required'));
      console.log('   - has_token:', !!localStorage.getItem('supabase_recovery_token'));
      console.log('   - token_type:', localStorage.getItem('supabase_recovery_type'));
      console.log('   - timestamp:', localStorage.getItem('reset_timestamp'));
      console.log('   - direct_link:', localStorage.getItem('direct_supabase_link'));
      console.log('   - auth_error_type:', localStorage.getItem('auth_error_type'));
      console.log('   - auth_error_email:', localStorage.getItem('auth_error_email'));
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing auth scenarios...');
      handleAllAuthScenarios();
      debugStoredTokens();
    });
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>