<!DOCTYPE html>
<html>
<head>
  <base href="./">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JRR Immigration App">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="JRR Immigration">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>JRR Immigration</title>
  <link rel="manifest" href="manifest.json">

  <script>
function handleAuthTokens() {
  try {
    const url = new URL(window.location.href);
    console.log("ðŸŒ Initial URL:", url.href);

    const queryParams = url.searchParams;
    const resetInitiated = queryParams.get("reset_initiated");

    const hashParams = new URLSearchParams(url.hash.substring(1));
    const token = hashParams.get("access_token");
    const type = hashParams.get("type");

    console.log("ðŸ” Token Detection:", {
      hasQueryFlag: resetInitiated === "true",
      hasDirectToken: !!token,
      type: type,
    });

    // -----------------------------
    // RESET INITIATED (from auth-callback.html)
    // -----------------------------
    if (resetInitiated === "true") {
      console.log("ðŸ”„ Reset flow initiated via redirect");
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
      return;
    }

    // -----------------------------
    // DIRECT TOKEN HANDLING (#access_token... in URL)
    // -----------------------------
    if (token && type === "recovery") {
      console.log("ðŸŽ¯ Direct token detected");

      const tokenType =
        token.startsWith("pkce_") ? "pkce" :
        token.length === 6 ? "otp" :
        "unknown";

      // Main storage for the Flutter reset screen
      localStorage.setItem("password_reset_required", "true");
      localStorage.setItem("supabase_recovery_token", token);
      localStorage.setItem("supabase_recovery_type", "recovery");
      localStorage.setItem("token_type", tokenType);
      localStorage.setItem("reset_timestamp", new Date().toISOString());

      // Sync storage for WebAuthHandler to pull into SharedPreferences
      

      console.log("âœ… Tokens stored in BOTH locations");

      // Remove token from URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // -----------------------------
    // Clean leftover hash fragments
    // -----------------------------
    if (url.hash.includes("access_token") || url.hash.includes("type=recovery")) {
      window.history.replaceState({}, document.title, window.location.pathname);
      console.log("ðŸ§¹ Cleaned token fragments");
    }

  } catch (error) {
    console.log("âŒ Error in token handler:", error);
  }
}

// Initialize flutter â†’ JS communication
window.addEventListener("load", function () {
  window.flutterChannel = {
    getItem: (key) => localStorage.getItem(key),
    setItem: (key, value) => localStorage.setItem(key, value),
    removeItem: (key) => localStorage.removeItem(key),
  };
});

// Execute when Flutter is ready
window.addEventListener("flutter-first-frame", function () {
  setTimeout(handleAuthTokens, 100);
});

// Fallback (e.g., slow browser)
document.addEventListener("DOMContentLoaded", function () {
  setTimeout(handleAuthTokens, 500);
});
</script>

</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>