<!DOCTYPE html>
<html>
<head>
  <base href="./">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JRR Immigration App">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="JRR Immigration">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>JRR Immigration</title>
  <link rel="manifest" href="manifest.json">

  <script>
  // Single, unified token handler
  function handleAuthTokens() {
    try {
      const url = new URL(window.location.href);
      console.log('ðŸŒ Initial URL:', url.href);
      
      // Check query parameters first (for redirect flags)
      const queryParams = url.searchParams;
      const resetInitiated = queryParams.get('reset_initiated');
      const authError = queryParams.get('auth_error');
      
      // Check fragment parameters (for direct tokens)
      const hashParams = new URLSearchParams(url.hash.substring(1));
      const token = hashParams.get('access_token');
      const type = hashParams.get('type');
      
      console.log('ðŸ” Token Detection:', { 
        hasQueryFlag: resetInitiated === 'true',
        hasDirectToken: !!token,
        type: type
      });
      
      // Handle redirect flags from auth-callback
      if (resetInitiated === 'true') {
        console.log('ðŸ”„ Reset flow initiated via redirect');
        // Don't process here - let Flutter handle stored tokens
        // Just clean the URL but preserve other query params if any
        const cleanUrl = window.location.pathname + (window.location.search.includes('auth_error') ? window.location.search : '');
        window.history.replaceState({}, document.title, cleanUrl);
        return;
      }
      
      // Handle direct token URLs (should be rare)
      if (token && type === 'recovery') {
        console.log('ðŸŽ¯ Direct recovery token detected in index.html');
        
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        
        console.log('âœ… Tokens stored in localStorage');
        
        // Clean URL completely
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Clean any remaining token fragments
      if (url.hash.includes('access_token') || url.hash.includes('type=recovery')) {
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
        console.log('ðŸ§¹ Token fragments cleaned');
      }
      
    } catch (error) {
      console.log('ðŸ” Token processing completed with error:', error);
    }
  }

  // Initialize Flutter channel for localStorage access
  window.addEventListener('load', function() {
    if (window.flutter_inappwebview != null) {
      window.flutter_inappwebview.callHandler = function(method, ...args) {
        if (method === 'getItem') return localStorage.getItem(args[0]);
        if (method === 'setItem') localStorage.setItem(args[0].key, args[0].value);
        if (method === 'removeItem') localStorage.removeItem(args[0]);
      };
    } else {
      window.flutterChannel = {
        getItem: (key) => localStorage.getItem(key),
        setItem: (key, value) => localStorage.setItem(key, value),
        removeItem: (key) => localStorage.removeItem(key)
      };
    }
  });

  // Run token handler when Flutter is ready
  window.addEventListener('flutter-first-frame', function() {
    setTimeout(handleAuthTokens, 100);
  });

  // Also run on DOM content loaded as fallback
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(handleAuthTokens, 500);
  });
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>