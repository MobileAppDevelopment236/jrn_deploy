<!DOCTYPE html>
<html>
<head>
  <base href="./">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JRR Immigration App">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="JRR Immigration">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>JRR Immigration</title>
  <link rel="manifest" href="manifest.json">
  
  <!-- ULTIMATE FIX: Handle ALL Supabase auth scenarios -->
  <script>
    // Comprehensive auth handler for ALL scenarios
    function handleAllAuthScenarios() {
      const currentUrl = window.location.href;
      const hash = window.location.hash;
      const search = window.location.search;
      
      console.log('üîó ULTIMATE URL Analysis:');
      console.log('   - Current URL:', currentUrl);
      console.log('   - Hash:', hash);
      console.log('   - Search:', search);
      
      // SCENARIO 1: Direct Supabase recovery link (user clicked email)
      if (currentUrl.includes('type=recovery') && currentUrl.includes('access_token')) {
        console.log('üéØ SCENARIO 1: Direct Supabase recovery link detected');
        handleDirectSupabaseRecovery();
        return;
      }
      
      // SCENARIO 2: Already stored tokens (from reset-password.html)
      if (localStorage.getItem('password_reset_required') === 'true') {
        console.log('üéØ SCENARIO 2: Stored reset tokens detected');
        // Tokens already stored, let Flutter handle it
        return;
      }
      
      // SCENARIO 3: URL parameters in main app
      if (hash.includes('access_token') || search.includes('access_token')) {
        console.log('üéØ SCENARIO 3: URL parameters in main app');
        handleUrlParameters();
        return;
      }
      
      console.log('‚ÑπÔ∏è No special auth scenario detected');
    }

    function handleDirectSupabaseRecovery() {
      console.log('üîÑ Processing direct Supabase recovery link...');
      
      // Extract token from current URL (Supabase direct link)
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      
      const token = urlParams.get('access_token') || hashParams.get('access_token');
      const type = urlParams.get('type') || hashParams.get('type');
      
      console.log('üîê Direct Supabase extraction:', {
        token: token ? '***' + token.slice(-8) : null,
        type: type
      });
      
      if (token && type === 'recovery') {
        console.log('‚úÖ Valid recovery token from direct Supabase link');
        
        // Store tokens
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        localStorage.setItem('direct_supabase_link', 'true');
        
        console.log('üîê Tokens stored from direct Supabase link');
        
        // Clean URL - remove all parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function handleUrlParameters() {
      console.log('üîÑ Processing URL parameters...');
      
      const hash = window.location.hash;
      const search = window.location.search;
      
      const params = new URLSearchParams();
      
      // Add query parameters
      if (search) {
        const searchParams = new URLSearchParams(search.substring(1));
        for (const [key, value] of searchParams.entries()) {
          params.set(key, value);
        }
      }
      
      // Add hash parameters
      if (hash) {
        const hashPart = hash.includes('?') ? hash.split('?')[1] : hash.substring(1);
        const hashParams = new URLSearchParams(hashPart);
        for (const [key, value] of hashParams.entries()) {
          params.set(key, value);
        }
      }
      
      const token = params.get('access_token');
      const type = params.get('type');
      
      if (token && type === 'recovery') {
        console.log('‚úÖ Valid recovery token from URL parameters');
        
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function debugStoredTokens() {
      console.log('üîç DEBUG Stored Tokens:');
      console.log('   - reset_required:', localStorage.getItem('password_reset_required'));
      console.log('   - has_token:', !!localStorage.getItem('supabase_recovery_token'));
      console.log('   - token_type:', localStorage.getItem('supabase_recovery_type'));
      console.log('   - timestamp:', localStorage.getItem('reset_timestamp'));
      console.log('   - direct_link:', localStorage.getItem('direct_supabase_link'));
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Initializing auth scenarios...');
      handleAllAuthScenarios();
      debugStoredTokens();
    });
  </script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>