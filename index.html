<!DOCTYPE html>
<html>
<head>
  <base href="./">
  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="JRR Immigration App">
  
  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="JRR Immigration">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>JRR Immigration</title>
  <link rel="manifest" href="manifest.json">

  <script>
  // MethodChannel implementation for localStorage access
  window.addEventListener('load', function() {
    if (window.flutter_inappwebview != null) {
      // For webview
      window.flutter_inappwebview.callHandler = function(method, ...args) {
        if (method === 'getItem') {
          return localStorage.getItem(args[0]);
        } else if (method === 'setItem') {
          localStorage.setItem(args[0].key, args[0].value);
        } else if (method === 'removeItem') {
          localStorage.removeItem(args[0]);
        }
      };
    } else {
      // For regular web
      window.flutterChannel = {
        getItem: function(key) {
          return localStorage.getItem(key);
        },
        setItem: function(key, value) {
          localStorage.setItem(key, value);
        },
        removeItem: function(key) {
          localStorage.removeItem(key);
        }
      };
    }
  });

  // Your existing token handling code...
  function handleURLParameters() {
    try {
      const url = new URL(window.location.href);
      const hashParams = new URLSearchParams(url.hash.substring(1));
      
      const token = hashParams.get('access_token');
      const type = hashParams.get('type');
      
      console.log('üîê URL Token Detection:', { 
        hasToken: !!token, 
        type: type
      });
      
      if (token && type === 'recovery') {
        console.log('üéØ Password reset token detected - storing in localStorage');
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        
        console.log('‚úÖ Tokens stored in localStorage');
      }
      
      // Clean URL but DON'T remove from localStorage
      if (url.hash.includes('access_token') || url.hash.includes('type=recovery')) {
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
        console.log('üßπ URL parameters cleaned');
      }
    } catch (error) {
      console.log('URL processing completed');
    }
  }

  document.addEventListener('DOMContentLoaded', handleURLParameters);
</script>
  
  <script>
  function handleURLParameters() {
    try {
      const url = new URL(window.location.href);
      const hashParams = new URLSearchParams(url.hash.substring(1));
      
      const token = hashParams.get('access_token');
      const type = hashParams.get('type');
      
      console.log('üîê URL Token Detection:', { 
        hasToken: !!token, 
        type: type
      });
      
      if (token && type === 'recovery') {
        console.log('üéØ Password reset token detected');
        
        // Store in localStorage (Flutter will check this via SharedPreferences)
        localStorage.setItem('password_reset_required', 'true');
        localStorage.setItem('supabase_recovery_token', token);
        localStorage.setItem('supabase_recovery_type', 'recovery');
        localStorage.setItem('reset_timestamp', new Date().toISOString());
        
        console.log('‚úÖ Tokens stored in localStorage');
      }
      
      // Clean URL parameters
      if (url.hash.includes('access_token') || url.hash.includes('type=recovery')) {
        window.history.replaceState({}, document.title, window.location.pathname);
        console.log('üßπ URL parameters cleaned');
      }
    } catch (error) {
      console.log('URL processing completed');
    }
  }

  // Wait for Flutter to be ready before processing
  window.addEventListener('flutter-first-frame', function() {
    setTimeout(handleURLParameters, 100);
  });

  // Also run on DOM content loaded as fallback
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(handleURLParameters, 500);
  });
</script>
</head>
<body>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>