<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset - JRR Immigration</title>
    <style>
        /* Keep your existing styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D97CE 0%, #1E3A8A 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #333;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: #0D97CE;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }
        h1 {
            color: #0D97CE;
            margin-bottom: 1rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }
        .error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }
        .loading {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #BFDBFE;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0D97CE;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üîí</div>
        <h1>Password Reset</h1>
        <div id="status" class="status loading">
            <div class="spinner"></div>
            <p>Processing your password reset request...</p>
        </div>
        <div id="message"></div>
    </div>
<script>
async function handlePasswordReset() {
    const statusEl = document.getElementById('status');
    const messageEl = document.getElementById('message');

    try {
        console.log('üîÑ Starting password reset processing...');
        console.log('üîó Full URL:', window.location.href);
        console.log('üîó Hash:', window.location.hash);
        console.log('üîó Search:', window.location.search);

        // CRITICAL FIX: Check BOTH query params AND hash fragment
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // Combine parameters (hash overrides query)
        const allParams = new URLSearchParams();
        
        // Add query parameters first
        for (const [key, value] of urlParams.entries()) {
            allParams.set(key, value);
        }
        
        // Add hash parameters (this is where Supabase puts tokens)
        for (const [key, value] of hashParams.entries()) {
            allParams.set(key, value);
        }

        const error = allParams.get('error');
        const errorCode = allParams.get('error_code');
        const errorDescription = allParams.get('error_description');
        const token = allParams.get('access_token') || allParams.get('token');
        const type = allParams.get('type');

        console.log('üîë Combined parameters:', {
            error: error,
            errorCode: errorCode,
            token: token ? '***' + token.slice(-8) : null,
            type: type
        });

        // Handle errors
        if (error || errorCode === 'otp_expired') {
            console.error('‚ùå Password reset error:', errorDescription);
            statusEl.className = 'status error';
            statusEl.innerHTML = `
                <h3>Reset Link Expired</h3>
                <p>This password reset link has expired. Please request a new one.</p>
                <button onclick="requestNewReset()" style="
                    background: #0D97CE;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-top: 10px;
                ">Request New Reset Link</button>
            `;
            return;
        }

        // Handle successful password reset token
        if (token && type === 'recovery') {
            console.log('‚úÖ Password reset token received:', token.slice(0, 10) + '...');
            
            // Store tokens in multiple locations for redundancy
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('password_reset_required', 'true');
                localStorage.setItem('reset_timestamp', new Date().toISOString());
                localStorage.setItem('supabase_recovery_token', token);
                localStorage.setItem('supabase_recovery_type', 'recovery');
                localStorage.setItem('recovery_token_raw', token);
                
                console.log('üîê Tokens stored in localStorage');
            }

            statusEl.className = 'status success';
            statusEl.innerHTML = `
                <h3>Reset Link Validated!</h3>
                <p>Redirecting you to set your new password...</p>
            `;

            // Redirect to Flutter app
            setTimeout(() => {
                console.log('üîÑ Redirecting to Flutter app...');
                window.location.href = 'https://www.jrrgo.com/#/reset-password';
            }, 1500);
            
        } else {
            console.error('‚ùå No valid reset token found');
            console.log('üí° Token available:', !!token);
            console.log('üí° Type:', type);
            statusEl.className = 'status error';
            statusEl.innerHTML = `
                <h3>Invalid Reset Link</h3>
                <p>This password reset link is invalid or malformed.</p>
                <p><small>Check browser console for details</small></p>
            `;
        }

    } catch (error) {
        console.error('üí• Error in password reset:', error);
        statusEl.className = 'status error';
        statusEl.innerHTML = `
            <h3>Processing Error</h3>
            <p>An unexpected error occurred. Please try again.</p>
        `;
    }
}

function requestNewReset() {
    window.location.href = 'https://www.jrrgo.com/#/forgot-password';
}

document.addEventListener('DOMContentLoaded', handlePasswordReset);
</script>
    
</body>
</html>