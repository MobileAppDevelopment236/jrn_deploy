<!DOCTYPE html>
<html>
<head>
    <title>Authentication Callback - JRR Immigration</title>
    <script>
        // Enhanced auth callback processor with comprehensive error handling
        function processAuthCallback() {
            console.log('üîÑ Starting authentication callback processing...');
            
            try {
                const url = new URL(window.location.href);
                console.log('üîê Full URL:', url.href);
                
                // Parse fragment parameters (URL after #)
                const fragment = url.hash.substring(1);
                const params = new URLSearchParams(fragment);
                
                // Extract all relevant parameters
                const accessToken = params.get('access_token'); // PKCE token
                const type = params.get('type');
                const traditionalToken = params.get('token'); // 6-digit code
                const error = params.get('error');
                const errorDescription = params.get('error_description');
                
                console.log('üì¶ Extracted Parameters:', { 
                    access_token: accessToken ? `PKCE (${accessToken.length} chars)` : 'null',
                    token: traditionalToken ? `Traditional (${traditionalToken.length} chars)` : 'null', 
                    type: type,
                    error: error,
                    error_description: errorDescription
                });
                
                // Handle authentication errors first
                if (error) {
                    console.error('‚ùå Authentication error detected:', error, errorDescription);
                    handleAuthError(error, errorDescription);
                    return;
                }
                
                // Process recovery flow (password reset)
                if (type === 'recovery') {
                    console.log('üéØ Processing recovery flow...');
                    processRecoveryFlow(accessToken, traditionalToken);
                    return;
                }
                
                // Handle other flow types if needed in future
                console.log('‚ÑπÔ∏è Unknown or unsupported flow type:', type);
                redirectToApp('?auth_error=unsupported_flow');
                
            } catch (error) {
                console.error('üí• Unhandled exception in auth callback:', error);
                handleAuthError('callback_error', error.toString());
            }
        }

        function processRecoveryFlow(accessToken, traditionalToken) {
            try {
                // FIXED: PREFER PKCE CODE OVER TRADITIONAL TOKEN (as per original logic)
                if (accessToken && accessToken.startsWith('pkce_')) {
                    console.log('üéØ Using PKCE recovery token (PREFERRED):', {
                        length: accessToken.length,
                        codePreview: accessToken.substring(0, 20) + '...'
                    });
                    
                    // Store PKCE token - THIS IS WHAT SUPABASE EXPECTS
                    storeRecoveryTokens({
                        token: accessToken,
                        type: 'recovery',
                        tokenType: 'pkce'
                    });
                    
                } else if (traditionalToken) {
                    console.log('üéØ Using traditional recovery token (FALLBACK):', {
                        length: traditionalToken.length,
                        token: traditionalToken
                    });
                    
                    // Store traditional token as fallback
                    storeRecoveryTokens({
                        token: traditionalToken,
                        type: 'recovery', 
                        tokenType: 'traditional'
                    });
                    
                } else {
                    console.error('‚ùå No valid recovery tokens found');
                    handleAuthError('missing_tokens', 'No access_token or token parameter found');
                    return;
                }
                
                console.log('‚úÖ Recovery tokens stored successfully');
                redirectToApp('?reset_initiated=true&source=auth_callback');
                
            } catch (error) {
                console.error('‚ùå Error in recovery flow processing:', error);
                handleAuthError('recovery_processing_error', error.toString());
            }
        }

        function storeRecoveryTokens(tokenData) {
            const timestamp = new Date().toISOString();
            
            // Store in localStorage (primary for web)
            localStorage.setItem('password_reset_required', 'true');
            localStorage.setItem('supabase_recovery_token', tokenData.token);
            localStorage.setItem('supabase_recovery_type', tokenData.type);
            localStorage.setItem('reset_timestamp', timestamp);
            localStorage.setItem('token_type', tokenData.tokenType);
            
            console.log('üíæ Tokens stored in localStorage:', {
                password_reset_required: 'true',
                supabase_recovery_token: `${tokenData.token.substring(0, 15)}...`,
                supabase_recovery_type: tokenData.type,
                token_type: tokenData.tokenType,
                timestamp: timestamp
            });
            
            // Also try to store in sessionStorage as backup
            try {
                sessionStorage.setItem('recovery_flow_active', 'true');
                sessionStorage.setItem('recovery_token_backup', tokenData.token);
            } catch (e) {
                console.log('‚ÑπÔ∏è Session storage not available:', e);
            }
        }

        function handleAuthError(errorType, errorDescription = '') {
            console.error('üö® Handling auth error:', errorType, errorDescription);
            
            // Store error information for the main app to handle
            localStorage.setItem('auth_error_type', errorType);
            if (errorDescription) {
                localStorage.setItem('auth_error_description', errorDescription);
            }
            localStorage.setItem('auth_error_timestamp', new Date().toISOString());
            
            // Redirect to main app with error parameters
            let redirectParams = `?auth_error=${encodeURIComponent(errorType)}`;
            if (errorDescription) {
                redirectParams += `&error_description=${encodeURIComponent(errorDescription)}`;
            }
            
            redirectToApp(redirectParams);
        }

        function redirectToApp(queryParams = '') {
            const baseUrl = 'https://www.jrrgo.com/';
            const redirectUrl = baseUrl + queryParams;
            
            console.log('üîÑ Redirecting to:', redirectUrl);
            
            // Use replace to avoid back button issues
            setTimeout(() => {
                window.location.replace(redirectUrl);
            }, 500); // Small delay to ensure storage operations complete
        }

        function cleanupUrl() {
            try {
                // Clear any sensitive data from URL after processing
                if (window.location.hash.includes('access_token') || 
                    window.location.hash.includes('token')) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                    console.log('üßπ Sensitive URL parameters cleared');
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è URL cleanup not possible:', error);
            }
        }

        function initializeAuthCallback() {
            console.log('üöÄ Initializing authentication callback...');
            
            // Add a small delay to ensure DOM is ready and any redirects can complete
            setTimeout(() => {
                try {
                    processAuthCallback();
                } catch (error) {
                    console.error('üí• Failed to process auth callback:', error);
                    // Final fallback - redirect to main app
                    redirectToApp('?auth_error=initialization_failed');
                }
            }, 100);
        }

        // Enhanced event listeners for robust initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM content loaded, starting auth processing...');
            initializeAuthCallback();
        });

        // Fallback: if DOMContentLoaded already fired, initialize immediately
        if (document.readyState === 'loading') {
            console.log('‚è≥ DOM still loading, waiting for DOMContentLoaded...');
        } else {
            console.log('‚ö° DOM already ready, initializing immediately...');
            initializeAuthCallback();
        }

        // Global error handler as final safety net
        window.addEventListener('error', function(event) {
            console.error('üí• Global error caught:', event.error);
            redirectToApp('?auth_error=global_error');
        });

        // Log startup information
        console.log('üîê Auth Callback Handler Loaded');
        console.log('üìç Current URL:', window.location.href);
        console.log('üïí Load Time:', new Date().toISOString());

    </script>
</head>
<body>
    <div style="font-family: Arial, sans-serif; text-align: center; padding: 50px; color: #333;">
        <h1 style="color: #0D97CE;">Processing Authentication...</h1>
        <p>Please wait while we complete your authentication.</p>
        <div style="margin: 30px 0;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0D97CE; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
        <p style="font-size: 14px; color: #666;">
            If this takes more than a few seconds, <a href="https://www.jrrgo.com/" style="color: #0D97CE;">click here</a> to return to the app.
        </p>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }
    </style>
</body>
</html>