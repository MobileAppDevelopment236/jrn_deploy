<!DOCTYPE html>
<html>
<head>
    <title>Authentication Callback</title>
    <script>
    function processAuthCallback() {
        try {
            const url = new URL(window.location.href);
            console.log('üîê Full URL:', url.href);
            
            // Extract from fragment (hash)
            const fragment = url.hash.substring(1);
            const params = new URLSearchParams(fragment);
            
            const accessToken = params.get('access_token'); // PKCE code
            const type = params.get('type');
            const traditionalToken = params.get('token'); // Traditional token
            const error = params.get('error');
            
            console.log('üîê Auth Callback Analysis:', { 
                access_token: accessToken ? `PKCE (${accessToken.length} chars)` : 'null',
                token: traditionalToken ? `Traditional (${traditionalToken.length} chars)` : 'null', 
                type: type,
                error: error
            });
            
            // Handle errors first
            if (error) {
                console.error('‚ùå Auth error:', error);
                localStorage.setItem('auth_error_type', error);
                window.location.href = 'https://www.jrrgo.com/?auth_error=' + error;
                return;
            }
            
            // Handle recovery token - PREFER traditional token for password reset
            if (type === 'recovery') {
                if (traditionalToken) {
                    console.log('üéØ Using TRADITIONAL recovery token:', {
                        length: traditionalToken.length,
                        token: traditionalToken
                    });
                    
                    // Store traditional token (this is what Supabase likely expects)
                    localStorage.setItem('password_reset_required', 'true');
                    localStorage.setItem('supabase_recovery_token', traditionalToken);
                    localStorage.setItem('supabase_recovery_type', 'recovery');
                    localStorage.setItem('reset_timestamp', new Date().toISOString());
                    localStorage.setItem('token_type', 'traditional'); // Mark as traditional
                    
                } else if (accessToken && accessToken.startsWith('pkce_')) {
                    console.log('üéØ Using PKCE recovery code:', {
                        length: accessToken.length,
                        code: accessToken.substring(0, 20) + '...'
                    });
                    
                    // Store PKCE code
                    localStorage.setItem('password_reset_required', 'true');
                    localStorage.setItem('supabase_recovery_token', accessToken);
                    localStorage.setItem('supabase_recovery_type', 'recovery');
                    localStorage.setItem('reset_timestamp', new Date().toISOString());
                    localStorage.setItem('token_type', 'pkce'); // Mark as PKCE
                }
                
                console.log('‚úÖ Recovery tokens stored in localStorage');
                
                // Redirect to app
                window.location.href = 'https://www.jrrgo.com/?reset_initiated=true&source=auth_callback';
            } else {
                console.log('‚ùå No recovery flow detected');
                window.location.href = 'https://www.jrrgo.com/';
            }
            
        } catch (error) {
            console.error('‚ùå Auth callback error:', error);
            localStorage.setItem('auth_error_type', 'callback_error');
            window.location.href = 'https://www.jrrgo.com/?auth_error=callback_error';
        }
    }
    
    // Run on page load
    document.addEventListener('DOMContentLoaded', processAuthCallback);
    </script>
</head>
<body>
    <p>Processing authentication... Please wait.</p>
</body>
</html>