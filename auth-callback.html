<!DOCTYPE html>
<html>
<head>
    <title>Authentication Callback</title>
    <script>
    function processAuthCallback() {
        try {
            const url = new URL(window.location.href);
            console.log('üîê Full URL:', url.href);
            
            // Extract from fragment (hash) - THIS IS WHERE SUPABASE PUTS TOKENS
            const fragment = url.hash.substring(1);
            const params = new URLSearchParams(fragment);
            
            const token = params.get('access_token');
            const type = params.get('type');
            const error = params.get('error');
            const errorDescription = params.get('error_description');
            
            console.log('üîê Auth Callback Processing:', { 
                token: token ? `PRESENT (${token.length} chars)` : 'null', 
                type: type,
                error: error,
                errorDescription: errorDescription
            });
            
            // Handle errors first
            if (error) {
                console.error('‚ùå Auth error:', error, errorDescription);
                localStorage.setItem('auth_error_type', error);
                localStorage.setItem('auth_error_description', errorDescription || '');
                window.location.href = 'https://www.jrrgo.com/?auth_error=' + error;
                return;
            }
            
            // Handle recovery token
            if (token && type === 'recovery') {
                console.log('üéØ Recovery token detected:', {
                    length: token.length,
                    startsWith: token.substring(0, 10) + '...',
                    hasDots: token.includes('.'),
                    hasUnderscores: token.includes('_')
                });
                
                // VALIDATE TOKEN LENGTH - Supabase tokens should be long
                if (token.length < 50) {
                    console.error('‚ùå INVALID TOKEN LENGTH - Too short:', token.length, 'characters');
                    console.error('‚ùå Token value:', token);
                    localStorage.setItem('auth_error_type', 'invalid_token_length');
                    localStorage.setItem('auth_error_description', 'Token is too short: ' + token.length + ' characters');
                    window.location.href = 'https://www.jrrgo.com/?auth_error=invalid_token';
                    return;
                }
                
                // Store tokens in localStorage
                localStorage.setItem('password_reset_required', 'true');
                localStorage.setItem('supabase_recovery_token', token);
                localStorage.setItem('supabase_recovery_type', type);
                localStorage.setItem('reset_timestamp', new Date().toISOString());
                
                console.log('‚úÖ Password reset tokens stored in localStorage');
                console.log('‚úÖ Token length:', token.length, 'characters');
                
                // Redirect with flag to signal Flutter app
                window.location.href = 'https://www.jrrgo.com/?reset_initiated=true&source=auth_callback';
            } else {
                console.log('‚ùå No valid recovery token found in URL');
                console.log('üîç Available params:', {
                    access_token: token ? 'PRESENT' : 'null',
                    type: type,
                    fragment: fragment.substring(0, 100) + '...'
                });
                window.location.href = 'https://www.jrrgo.com/';
            }
            
        } catch (error) {
            console.error('‚ùå Auth callback error:', error);
            localStorage.setItem('auth_error_type', 'callback_error');
            localStorage.setItem('auth_error_description', error.toString());
            window.location.href = 'https://www.jrrgo.com/?auth_error=callback_error';
        }
    }
    
    // Run on page load
    document.addEventListener('DOMContentLoaded', processAuthCallback);
    </script>
</head>
<body>
    <p>Processing authentication... Please wait.</p>
</body>
</html>