<!DOCTYPE html>
<html>
<head>
  <title>Password Reset - JRR GO</title>

  <script>
    console.log("ðŸ” Auth Callback Loaded:", window.location.href);

    /* -----------------------------------------------------------
       1. Extract token, type, email from URL fragment (#...)
    ----------------------------------------------------------- */
    function extractToken() {
      const hash = window.location.hash.substring(1);
      console.log("ðŸ“¦ Raw Hash:", hash);

      // --- CASE 1: JSON fragment (#{"type":"recovery","token":"xxx"}) ---
      if (hash.startsWith("{")) {
        try {
          const json = JSON.parse(hash);
          console.log("ðŸ“„ Parsed JSON token:", json);

          return {
            token: json.access_token || json.token || "",
            type: json.type || "",
            email: json.email || ""
          };
        } catch (e) {
          console.log("âš ï¸ JSON parse failed:", e);
        }
      }

      // --- CASE 2: Normal fragment (#token=xxx&type=recovery&email=...) ---
      const params = new URLSearchParams(hash);

      const parsed = {
        token: params.get("token") || params.get("access_token") || "",
        type: params.get("type") || "",
        email: decodeURIComponent(params.get("email") || "")
      };

      console.log("ðŸ” Parsed Params:", parsed);
      return parsed;
    }

    /* -----------------------------------------------------------
       2. Save token & email & flags into storage
    ----------------------------------------------------------- */
    function storeRecovery({ email, token, type }) {
      console.log("ðŸ’¾ Storing Recovery Dataâ€¦");

      // main storage
      localStorage.setItem("supabase_recovery_email", email || "");
      localStorage.setItem("supabase_recovery_token", token || "");
      localStorage.setItem("supabase_recovery_type", type || "");
      localStorage.setItem("password_reset_required", "true");

      // backup for race conditions
      try {
        sessionStorage.setItem("supabase_recovery_email_backup", email || "");
        sessionStorage.setItem("supabase_recovery_token_backup", token || "");
      } catch (e) {
        console.log("â„¹ï¸ sessionStorage backup failed:", e);
      }

      console.log("âœ… Stored:", { email, token, type });
    }

    /* -----------------------------------------------------------
       3. Redirect back to Flutter web app safely
    ----------------------------------------------------------- */
    function redirectBack(email) {
      console.log("ðŸ”„ Redirecting back to app");

      const base = "https://www.jrrgo.com/";
      const params = new URLSearchParams();

      params.set("reset_initiated", "true");

      if (email) {
        params.set("recovery_email", email);
      }

      // Clean sensitive URL
      try {
        window.history.replaceState({}, "", "/auth-callback.html");
      } catch (e) {}

      const redirectUrl = base + "?" + params.toString();
      console.log("âž¡ï¸ Redirect URL:", redirectUrl);

      setTimeout(() => {
        window.location.replace(redirectUrl);
      }, 200);
    }

    /* -----------------------------------------------------------
       4. Main Initialization
    ----------------------------------------------------------- */
    function init() {
      const extracted = extractToken();
      console.log("ðŸ“¦ Final Extracted:", extracted);

      const token = extracted.token || "";

      // Validate token (OTP or access_token)
      if (!token || token.length < 3) {
        console.error("âŒ Invalid token received");
        redirectBack(extracted.email || "");
        return;
      }

      // Validate flow type
      if (extracted.type !== "recovery") {
        console.error("âŒ Not a recovery flow");
        redirectBack(extracted.email || "");
        return;
      }

      // Validate email
      if (!extracted.email || extracted.email.length < 3) {
        console.warn("âš ï¸ Email missing in URL");
        storeRecovery({
          email: "",
          token: token,
          type: extracted.type
        });
        redirectBack("");
        return;
      }

      // Store valid recovery data
      storeRecovery({
        email: extracted.email,
        token: token,
        type: extracted.type
      });

      // Redirect back to Flutter web app
      redirectBack(extracted.email);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>

</head>

<body style="font-family: Arial; text-align:center; padding:40px;">
  <h1 style="color:#0D97CE;">Processing Password Resetâ€¦</h1>
  <p>Please wait while we prepare your reset session.</p>
</body>
</html>
