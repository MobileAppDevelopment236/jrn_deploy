<!DOCTYPE html>
<html>
<head>
  <title>Password Reset - JRR Immigration</title>
  <script>
    console.log("ðŸ” Auth Callback Loaded:", window.location.href);

    function extractToken() {
      const hash = window.location.hash.substring(1);
      console.log("ðŸ“¦ Raw Hash:", hash);

      // Try JSON format first (#{"type":"recovery","access_token":"xxx"})
      if (hash.startsWith("{")) {
        try {
          const json = JSON.parse(hash);
          console.log("ðŸ“„ Parsed JSON token:", json);
          return {
            accessToken: json.access_token || json.token || "",
            type: json.type || "",
            email: json.email || ""
          };
        } catch (e) {
          console.log("âš ï¸ JSON parse failed:", e);
        }
      }

      // Normal hash format
      const params = new URLSearchParams(hash);
      console.log("ðŸ” Parsed Params:", Object.fromEntries(params.entries()));

      return {
        accessToken: params.get("access_token") || params.get("token") || "",
        type: params.get("type") || "",
        email: params.get("email") || ""
      };
    }

    function storeRecovery({ email, accessToken, type }) {
      console.log("ðŸ’¾ Storing Recovery Dataâ€¦");

      localStorage.setItem("supabase_recovery_email", email);
      localStorage.setItem("supabase_recovery_token", accessToken);
      localStorage.setItem("supabase_recovery_type", type);
      localStorage.setItem("password_reset_required", "true");

      console.log("âœ… Stored:", { email, accessToken, type });
    }

    function redirectBack() {
      console.log("ðŸ”„ Redirecting back to app");
      window.history.replaceState({}, "", "/auth-callback.html");
      setTimeout(() => {
        window.location.replace("https://www.jrrgo.com/?reset_initiated=true");
      }, 200);
    }

    function init() {
      const data = extractToken();

      console.log("ðŸ“¦ Final Extracted:", data);

      if (!data.accessToken || data.accessToken.length < 5) {
        console.error("âŒ No valid access token detected!");
        redirectBack();
        return;
      }

      if (!data.type || data.type !== "recovery") {
        console.error("âŒ Not a recovery flow!");
        redirectBack();
        return;
      }

      storeRecovery(data);
      redirectBack();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</head>

<body style="font-family: Arial; text-align:center; padding:40px;">
  <h1 style="color:#0D97CE;">Processing Password Resetâ€¦</h1>
  <p>Please wait while we prepare your reset session.</p>
</body>

</html>
