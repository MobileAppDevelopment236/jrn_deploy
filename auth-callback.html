<!DOCTYPE html>
<html>
<head>
  <title>Password Reset - JRR GO</title>

  <script>
  console.log("ðŸ” Auth Callback Loaded:", window.location.href);

  function extractToken() {
    const hash = window.location.hash.substring(1);
    console.log("ðŸ“¦ Raw Hash:", hash);

    if (hash.startsWith("{")) {
      try {
        const json = JSON.parse(hash);
        console.log("ðŸ“„ Parsed JSON token:", json);
        return {
          token: json.access_token || json.token || "",
          type: json.type || "",
          email: json.email || ""
        };
      } catch (e) {
        console.log("âš ï¸ JSON parse failed:", e);
      }
    }

    const params = new URLSearchParams(hash);
    const data = {
      token: params.get("token") ||
             params.get("access_token") || "",
      type: params.get("type") || "",
      email: params.get("email") || ""
    };

    console.log("ðŸ” Parsed Params:", data);
    return data;
  }

  function storeRecovery({ email, token, type }) {
    console.log("ðŸ’¾ Storing Recovery Dataâ€¦");

    localStorage.setItem("supabase_recovery_email", email || "");
    localStorage.setItem("supabase_recovery_token", token || "");
    localStorage.setItem("supabase_recovery_type", type || "");
    localStorage.setItem("password_reset_required", "true");

    try {
      sessionStorage.setItem("supabase_recovery_email_backup", email || "");
      sessionStorage.setItem("supabase_recovery_token_backup", token || "");
    } catch (e) {
      console.log("â„¹ï¸ sessionStorage backup failed:", e);
    }

    console.log("âœ… Stored:", { email, token, type });
  }

  function redirectBack(email) {
    console.log("ðŸ”„ Redirecting back to app");

    const base = "https://www.jrrgo.com/";
    const params = new URLSearchParams();

    params.set("reset_initiated", "true");
    if (email) params.set("recovery_email", email);

    try {
      window.history.replaceState({}, "", "/auth-callback.html");
    } catch (e) {}

    const redirectUrl = base + "?" + params.toString();
    console.log("âž¡ï¸ Redirect URL:", redirectUrl);

    setTimeout(() => {
      window.location.replace(redirectUrl);
    }, 200);
  }

  function init() {
    const extracted = extractToken();
    console.log("ðŸ“¦ Final Extracted:", extracted);

    const token = extracted.token || "";

    if (!token || token.length < 3) {
      console.error("âŒ Invalid token received");
      redirectBack(extracted.email || "");
      return;
    }

    if (extracted.type !== "recovery") {
      console.error("âŒ Not a recovery flow");
      redirectBack(extracted.email || "");
      return;
    }

    if (!extracted.email || extracted.email.length < 3) {
      console.warn("âš ï¸ Email missing in URL");
      storeRecovery({ email: "", token: token, type: extracted.type });
      redirectBack("");
      return;
    }

    storeRecovery({
      email: extracted.email,
      token: token,
      type: extracted.type
    });

    redirectBack(extracted.email);
  }

  document.addEventListener("DOMContentLoaded", init);
  </script>

</head>

<body style="font-family: Arial; text-align:center; padding:40px;">
  <h1 style="color:#0D97CE;">Processing Password Resetâ€¦</h1>
  <p>Please wait while we prepare your reset session.</p>
</body>
</html>
