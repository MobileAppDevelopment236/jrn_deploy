<!DOCTYPE html>
<html>
<head>
    <title>Authentication Callback - JRR Immigration</title>
    <script>
        // ENHANCED: Handle ALL authentication callbacks with priority on password recovery
        function handleAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            
            // Get parameters from both URL search and hash
            const access_token = urlParams.get('access_token') || hashParams.get('access_token');
            const refresh_token = urlParams.get('refresh_token') || hashParams.get('refresh_token');
            const token = urlParams.get('token') || hashParams.get('token');
            const type = urlParams.get('type') || hashParams.get('type');
            const error = urlParams.get('error') || hashParams.get('error');
            const error_description = urlParams.get('error_description') || hashParams.get('error_description');
            
            console.log('üîê Auth callback parameters:', { 
                type, 
                error,
                has_access_token: !!access_token,
                has_token: !!token,
                full_url: window.location.href
            });

            // Update UI to show processing
            document.getElementById('status').className = 'status processing';
            document.getElementById('status').innerHTML = `
                <div class="spinner"></div>
                <p>Processing authentication...</p>
            `;

            // SCENARIO 1: Handle PASSWORD RECOVERY (HIGHEST PRIORITY)
            if (type === 'recovery' && (access_token || token)) {
                console.log('‚úÖ PASSWORD RECOVERY callback detected');
                handlePasswordRecovery(access_token || token);
                return;
            }

            // SCENARIO 2: Handle errors
            if (error) {
                console.error('‚ùå Auth error:', error, error_description);
                handleAuthError(error, error_description);
                return;
            }

            // SCENARIO 3: Handle EMAIL VERIFICATION (signup)
            if (type === 'signup' && (access_token || token)) {
                console.log('‚úÖ Email verification successful');
                handleEmailVerification(access_token, refresh_token);
                return;
            }

            // SCENARIO 4: Handle other cases or fallback
            console.log('‚ÑπÔ∏è General auth callback, redirecting to main app');
            setTimeout(() => {
                window.location.href = 'https://www.jrrgo.com/';
            }, 1000);
        }

        // In auth-callback.html - UPDATE the handlePasswordRecovery function:

// REPLACE the handlePasswordRecovery function in auth-callback.html:
// REPLACE the handlePasswordRecovery function in auth-callback.html:

function handlePasswordRecovery(token) {
    console.log('üîÑ Processing password recovery...');
    
    // CRITICAL: Store in multiple locations for redundancy
    
    // 1. Store in regular localStorage (for JavaScript detection)
    localStorage.setItem('password_reset_required', 'true');
    localStorage.setItem('supabase_recovery_token', token);
    localStorage.setItem('supabase_recovery_type', 'recovery');
    localStorage.setItem('reset_timestamp', new Date().toISOString());
    
    // 2. Store in sessionStorage for immediate detection
    sessionStorage.setItem('immediate_password_reset', 'true');
    sessionStorage.setItem('immediate_recovery_token', token);
    sessionStorage.setItem('immediate_reset_timestamp', new Date().toISOString());
    
    // 3. Store additional flags for better detection
    localStorage.setItem('recovery_detected_at', new Date().toISOString());
    localStorage.setItem('callback_processed', 'true');
    
    console.log('üîê Recovery tokens stored in multiple locations');
    console.log('üì¶ Stored tokens debug:');
    console.log('   - password_reset_required:', localStorage.getItem('password_reset_required'));
    console.log('   - has_token:', !!localStorage.getItem('supabase_recovery_token'));
    console.log('   - token_type:', localStorage.getItem('supabase_recovery_type'));
    console.log('   - immediate_reset:', sessionStorage.getItem('immediate_password_reset'));
    console.log('   - recovery_detected_at:', localStorage.getItem('recovery_detected_at'));
    
    // Update UI
    document.getElementById('status').className = 'status success';
    document.getElementById('status').innerHTML = `
        <h3>Password Reset Ready!</h3>
        <p>All tokens have been stored successfully.</p>
        <p>Redirecting to set your new password...</p>
    `;

    // Redirect to main app
    setTimeout(() => {
        console.log('üîÑ Redirecting to main app for password reset...');
        window.location.href = 'https://www.jrrgo.com/';
    }, 2000);
}

        function handleEmailVerification(access_token, refresh_token) {
            console.log('üîÑ Processing email verification...');
            
            // Store verification success
            localStorage.setItem('email_verification_success', 'true');
            localStorage.setItem('verification_timestamp', new Date().toISOString());
            
            // Store tokens if available
            if (access_token) {
                localStorage.setItem('supabase_auth_token', access_token);
            }
            if (refresh_token) {
                localStorage.setItem('supabase_refresh_token', refresh_token);
            }

            // Update UI
            document.getElementById('status').className = 'status success';
            document.getElementById('status').innerHTML = `
                <h3>Email Verified!</h3>
                <p>Your email has been verified successfully. Redirecting to app...</p>
            `;

            // Redirect to main app
            setTimeout(() => {
                console.log('üîÑ Redirecting to main app after verification...');
                window.location.href = 'https://www.jrrgo.com/';
            }, 2000);
        }

        function handleAuthError(error, error_description) {
            console.error('‚ùå Handling auth error:', error);
            
            // Store error information
            localStorage.setItem('auth_error', error);
            if (error_description) {
                localStorage.setItem('auth_error_description', error_description);
            }
            
            // Store specific error types
            if (error === 'otp_expired') {
                localStorage.setItem('auth_error_type', 'otp_expired');
                localStorage.setItem('auth_error_timestamp', new Date().toISOString());
            }

            // Update UI
            document.getElementById('status').className = 'status error';
            document.getElementById('status').innerHTML = `
                <h3>Authentication Error</h3>
                <p>${error_description || error}</p>
                <p>Redirecting to app...</p>
            `;

            // Redirect to main app - Flutter will handle the error
            setTimeout(() => {
                console.log('üîÑ Redirecting to main app with error...');
                window.location.href = 'https://www.jrrgo.com/';
            }, 2000);
        }

        // Start processing when page loads
        document.addEventListener('DOMContentLoaded', handleAuthCallback);
    </script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0D97CE 0%, #1E3A8A 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #333;
        }
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            background: #0D97CE;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
        }
        h1 {
            color: #0D97CE;
            margin-bottom: 1rem;
        }
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .processing {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #BFDBFE;
        }
        .success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }
        .error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #FECACA;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0D97CE;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">üîê</div>
        <h1>Authentication</h1>
        <div id="status" class="status processing">
            <div class="spinner"></div>
            <p>Processing authentication...</p>
        </div>
    </div>
</body>
</html>