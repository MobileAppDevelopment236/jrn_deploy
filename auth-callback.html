<!DOCTYPE html>
<html>
<head>
  <title>Password Reset - JRR Immigration</title>
  <script>
    console.log("ðŸ” Auth Callback Loaded:", window.location.href);

    function extractToken() {
      const hash = window.location.hash.substring(1);
      console.log("ðŸ“¦ Raw Hash:", hash);

      // CASE 1: JSON format (#{"type":"recovery","access_token":"xxx"})
      if (hash.startsWith("{")) {
        try {
          const json = JSON.parse(hash);
          console.log("ðŸ“„ Parsed JSON token:", json);
          return {
            accessToken: json.access_token || "",
            token: json.token || "",
            type: json.type || "",
            email: json.email || ""
          };
        } catch (e) {
          console.log("âš ï¸ JSON parse failed:", e);
        }
      }

      // CASE 2: Normal hash format (#token=xxx&type=recovery&email=...)
      const params = new URLSearchParams(hash);
      const parsed = {
        accessToken: params.get("access_token") || "",
        token: params.get("token") || "",
        type: params.get("type") || "",
        email: params.get("email") || ""
      };

      console.log("ðŸ” Parsed Params:", parsed);
      return parsed;
    }

    function storeRecovery({ email, token, type }) {
      try {
        console.log("ðŸ’¾ Storing Recovery Data in localStorage & sessionStorageâ€¦");

        localStorage.setItem("supabase_recovery_email", email || "");
        localStorage.setItem("supabase_recovery_token", token || "");
        localStorage.setItem("supabase_recovery_type", type || "");
        localStorage.setItem("password_reset_required", "true");

        // sessionStorage backup (helps short-lived navigation/race conditions)
        try {
          sessionStorage.setItem("supabase_recovery_email_backup", email || "");
          sessionStorage.setItem("supabase_recovery_token_backup", token || "");
          sessionStorage.setItem("password_reset_required_backup", "true");
        } catch (e) {
          console.log("â„¹ï¸ sessionStorage not available:", e);
        }

        console.log("âœ… Stored:", { email, token, type });
      } catch (e) {
        console.error("âŒ Error storing recovery data:", e);
      }
    }

    function safeRedirect(email) {
      // Build redirect URL with fallback email query param to ensure Flutter can read it.
      // Keeps existing reset_initiated flag for your app logic while adding email as fallback.
      const base = "https://www.jrrgo.com/";
      const params = new URLSearchParams();
      params.set("reset_initiated", "true");
      if (email) params.set("recovery_email", email);

      // Clean address bar before redirect (remove sensitive fragment)
      try {
        window.history.replaceState({}, document.title, "/auth-callback.html");
      } catch (e) {
        console.log("â„¹ï¸ history.replaceState failed:", e);
      }

      const redirectUrl = base + "?" + params.toString();
      console.log("ðŸ”„ Redirecting to:", redirectUrl);

      // short delay to ensure storage writes complete on some browsers
      setTimeout(() => {
        window.location.replace(redirectUrl);
      }, 250);
    }

    function init() {
      const extracted = extractToken();
      console.log("ðŸ“¦ Final Extracted:", extracted);

      // Support both accessToken (JWT) and token (OTP)
      const realToken = extracted.accessToken || extracted.token || "";

      // Validate token
      if (!realToken || realToken.length < 3) { // allow short OTP (3+ digits)
        console.error("âŒ No valid recovery token detected!");
        // redirect but include email if available as best-effort
        safeRedirect(extracted.email || "");
        return;
      }

      // Validate flow type
      if (!extracted.type || extracted.type !== "recovery") {
        console.error("âŒ Not a recovery flow!");
        safeRedirect(extracted.email || "");
        return;
      }

      // Validate email
      if (!extracted.email || extracted.email.length < 3) {
        console.warn("âš ï¸ No email in fragment â€” will still store token and redirect with no-email fallback.");
        // store token with empty email (we still store OTP so user can re-supply email in-app if needed)
        storeRecovery({ email: "", token: realToken, type: extracted.type });
        safeRedirect("");
        return;
      }

      // Store the validated data and redirect (email also included in redirect query string)
      storeRecovery({ email: extracted.email, token: realToken, type: extracted.type });
      safeRedirect(extracted.email);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</head>

<body style="font-family: Arial; text-align:center; padding:40px;">
  <h1 style="color:#0D97CE;">Processing Password Resetâ€¦</h1>
  <p>Please wait while we prepare your reset session.</p>
</body>
</html>
