<!DOCTYPE html>
<html>
<head>
    <title>Authentication Callback - JRR Immigration</title>
    <script>
        function processAuthCallback() {
            console.log('ðŸ”„ Processing auth callback...');
            
            try {
                const url = new URL(window.location.href);
                const fragment = url.hash.substring(1);
                const params = new URLSearchParams(fragment);
                
                // Get token (OTP uses 'token', PKCE uses 'access_token')
                const token = params.get('token') || params.get('access_token');
                const type = params.get('type');
                const error = params.get('error');
                
                console.log('ðŸ“¦ Extracted:', { token, type, error });
                
                if (error) {
                    console.error('âŒ Auth error:', error);
                    localStorage.setItem('auth_error', error);
                    redirectToApp('?auth_error=' + encodeURIComponent(error));
                    return;
                }
                
                if (!token || !type) {
                    console.error('âŒ Missing token or type');
                    localStorage.setItem('auth_error', 'missing_params');
                    redirectToApp('?auth_error=missing_params');
                    return;
                }
                
                if (type !== 'recovery') {
                    console.error('âŒ Not recovery flow:', type);
                    redirectToApp('?auth_error=invalid_flow');
                    return;
                }
                
                // Store for Flutter app
                localStorage.setItem('password_reset_required', 'true');
                localStorage.setItem('supabase_recovery_token', token);
                localStorage.setItem('supabase_recovery_type', type);
                localStorage.setItem('reset_timestamp', new Date().toISOString());
                
                // Check if token is OTP (6-digit) or PKCE
                if (token.startsWith('pkce_')) {
                    localStorage.setItem('token_type', 'pkce');
                } else if (token.length === 6) {
                    localStorage.setItem('token_type', 'otp');
                }
                
                console.log('âœ… Tokens stored successfully');
                redirectToApp('?reset_initiated=true');
                
            } catch (error) {
                console.error('ðŸ’¥ Error:', error);
                redirectToApp('?auth_error=processing_error');
            }
        }

        function redirectToApp(queryParams) {
            const baseUrl = 'https://www.jrrgo.com/';
            const redirectUrl = baseUrl + (queryParams || '');
            
            console.log('ðŸ”„ Redirecting to:', redirectUrl);
            
            // Clean URL
            window.history.replaceState({}, '', '/auth-callback.html');
            
            setTimeout(() => {
                window.location.replace(redirectUrl);
            }, 300);
        }

        // Start on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', processAuthCallback);
        } else {
            processAuthCallback();
        }
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial;">
        <h1 style="color: #0D97CE;">Processing Reset Link...</h1>
        <p>Please wait while we set up your password reset.</p>
        <div style="margin: 30px;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0D97CE; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        body { margin: 0; padding: 0; background: #f5f5f5; }
    </style>
</body>
</html>