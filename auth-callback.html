<!DOCTYPE html>
<html>
<head>
  <title>Password Reset - JRR Immigration</title>
  <script>
    console.log("ðŸ” Auth Callback Loaded:", window.location.href);

    function extractToken() {
      const hash = window.location.hash.substring(1);
      console.log("ðŸ“¦ Raw Hash:", hash);

      // --- CASE 1: JSON Format (#{"type":"recovery","access_token":"xxx"}) ---
      if (hash.startsWith("{")) {
        try {
          const json = JSON.parse(hash);
          console.log("ðŸ“„ Parsed JSON token:", json);

          return {
            accessToken: json.access_token || "",
            token: json.token || "",
            type: json.type || "",
            email: json.email || ""
          };
        } catch (e) {
          console.log("âš ï¸ JSON parse failed:", e);
        }
      }

      // --- CASE 2: Normal hash format (#token=xxx&type=recovery&email=...) ---
      const params = new URLSearchParams(hash);
      const parsed = {
        accessToken: params.get("access_token") || "",
        token: params.get("token") || "",
        type: params.get("type") || "",
        email: params.get("email") || ""
      };

      console.log("ðŸ” Parsed Params:", parsed);
      return parsed;
    }

    function storeRecovery({ email, token, type }) {
      console.log("ðŸ’¾ Storing Recovery Dataâ€¦");

      localStorage.setItem("supabase_recovery_email", email);
      localStorage.setItem("supabase_recovery_token", token);
      localStorage.setItem("supabase_recovery_type", type);
      localStorage.setItem("password_reset_required", "true");

      console.log("âœ… Stored:", { email, token, type });
    }

    function redirectBack() {
      console.log("ðŸ”„ Redirecting back to app");

      // Clean URL (remove sensitive data)
      window.history.replaceState({}, "", "/auth-callback.html");

      setTimeout(() => {
        window.location.replace("https://www.jrrgo.com/?reset_initiated=true");
      }, 200);
    }

    function init() {
      const extracted = extractToken();
      console.log("ðŸ“¦ Final Extracted:", extracted);

      // NEW: Support both accessToken (JWT) and token (OTP)
      const realToken = extracted.accessToken || extracted.token;

      // Validate token
      if (!realToken || realToken.length < 4) {
        console.error("âŒ No valid recovery token detected!");
        redirectBack();
        return;
      }

      // Validate flow type
      if (!extracted.type || extracted.type !== "recovery") {
        console.error("âŒ Not a recovery flow!");
        redirectBack();
        return;
      }

      // Validate email
      if (!extracted.email || extracted.email.length < 3) {
        console.error("âŒ Missing email in reset callback!");
        redirectBack();
        return;
      }

      // Store final validated data
      storeRecovery({
        email: extracted.email,
        token: realToken,
        type: extracted.type
      });

      redirectBack();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</head>

<body style="font-family: Arial; text-align:center; padding:40px;">
  <h1 style="color:#0D97CE;">Processing Password Resetâ€¦</h1>
  <p>Please wait while we prepare your reset session.</p>
</body>

</html>
